<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8"/>
	<title>Treemap</title>
	<!-- Place favicon.ico and apple-touch-icon.png in the root of your domain and delete these references
	<link rel="shortcut icon" href="/favicon.ico">
  -->
  <link rel="icon"
    type="image/png"
    href="/static/img/favicon.32.png" />
  <link rel="shortcut icon" href="/static/img/favicon.ico">

	<!--[if lt IE 9]>
		<script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
	<![endif]-->
	<link rel="stylesheet" media="all" href=""/>
	<meta name="viewport" content="width=device-width, initial-scale=1"/>
	<!-- Adding "maximum-scale=1" fixes the Mobile Safari auto-zoom bug: http://filamentgroup.com/examples/iosScaleBug/ -->

  <!-- TODO: separate out tributary ui styling from header styling? some of it overlaps 
  <link rel="stylesheet" href="/static/css/trib.css">
  <link rel="stylesheet" href="/static/css/animation.css">
  <link href='http://fonts.googleapis.com/css?family=Ubuntu+Mono:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
  <link rel="stylesheet" href="/static/css/tipsy.css">
  <link rel='stylesheet' type='text/css' href='http://yui.yahooapis.com/2.9.0/build/reset/reset-min.css' />
-->

  <!-- And the main styles -->
  <link rel="stylesheet" href="/static/css/header.css" type="text/css" media="screen" title="Primary Stylesheet" charset="utf-8">

  <!-- Add jQuery -->
  <script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
  <!-- d3 -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.5/d3.js"></script>
  <script src="bower_components/d3-tip/index.js"></script> 
  <!-- <script src="js/bootstrap-popover.js"></script>-->
  <script src="data-converted.json"></script> 
  
  <!-- Bootstrap
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css">
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
 -->

<style>
.d3-tip {
  line-height: 1;
  font-weight: bold;
  padding: 12px;
  background: rgba(0, 0, 0, 0.8);
  color: #fff;
  border-radius: 2px;
}

/* Creates a small triangle extender for the tooltip */
.d3-tip.n:after {
  box-sizing: border-box;
  display: inline;
  font-size: 10px;
  width: 100%;
  line-height: 1;
  color: rgba(0, 0, 0, 0.8);
  content: "\25BC";
  position: absolute;
  text-align: center;
}

/* Style northward tooltips differently */
.d3-tip.n:after {
  margin: -1px 0 0 0;
  top: 100%;
  left: 0;
}

</style>



</head>
<body>
<div class="container">
This will be amazing header text.
</div>

<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" xlink:xlink="http://www.w3.org/1999/xlink" class="tributary_svg0" width="100%" height="1600"></svg>
<script>

window.dataIndex = 0;
function getNextData() {
  data = []
  targetIndex = window.dataIndex + 1
  for (i = window.dataIndex * 8; i < targetIndex * 8; i++) { 
    data.push(pathJson['children'][i]);
  }
  hash = {};
  hash['children'] = data;
  return hash;
}

function DrawTreeMap() {

        var w = window.innerWidth,
            h = 1600,
            x = d3.scale.linear().range([0, w]),
            y = d3.scale.linear().range([0, h]),
			pad = 25,
            color = d3.scale.category10(),
            root,
            node;


        var treemap = d3.layout.treemap()
						.round(false)
						.size([w, h])
						.sticky(false)
						.mode("squarify")
						.ratio(1)
						.padding([pad, 10, 10, 10])
						.value(function (d) {return d.size;});

        var tip = d3.tip()
          .attr('class', 'd3-tip')
          .offset([-10, 0])
          .html(function(d) {
            return "<strong>Frequency:</strong> <span style='color:red'>" + d.frequency + "</span>";
          })

        tip.direction(function(d) {
          if(d.x < 40) return 'e'
          if((window.innerWidth - d.x - d.dx) < 40) return 'w';
          return 'n';
        })

        var svg = d3.select(".tributary_svg"+window.dataIndex.toString())
            		.append("svg:svg")
                              	.attr('id', 'my-svg-div')
					.attr("width", w)
					.attr("height", h)
					.append("svg:g")
					.attr("transform", "translate(.5,.5)");

        svg.call(tip);

//        node = root = pathJson;
        node = root = getNextData();

        var nodes = treemap.nodes(root);
        var children = nodes.filter(function (d) {return !d.children;});
        var parents = nodes.filter(function (d) {return d.children;});

        var childCell = svg.selectAll("g")
						   .data(children)
						   .enter().append("svg:g")
						   .attr("class", "childCell")
						   .attr("transform", function (d) {
									return "translate(" + d.x + "," + d.y + ")";})
                                 .on('mouseover', tip.show)
                                 .on('mouseout', tip.hide);

        childCell.append("svg:rect")
			     .attr("width", function (d) {return d.dx - 1;})
				 .attr("height", function (d) {return d.dy - 1;})
				 .attr("rx", 7)
				 .attr("ry", 7)
				 .style("fill", function (d) {if (d.win == 0) { return "rgb(125,125,125)" } else { return color(d.parent.name);}})


//        childCell.append("svg:text")
//				 .attr("x", function (d) {return d.dx / 2;})
//				 .attr("y", function (d) {return d.dy / 2;})
//				 .attr("dy", ".35em")
//				 .attr("text-anchor", "middle")
//				 .text(function (d) {return d.name;})
//				 .style("opacity", function (d) {
//						d.w = this.getComputedTextLength();
//						return d.dx > d.w ? 1 : 0;
//					});

        var parentCell = svg.selectAll("g.parentCell")
							.data(parents)
							.enter().append("svg:g")
							.attr("class", "parentCell")
							.attr("transform", function (d) {
								return "translate(" + d.x + "," + d.y + ")";});

        parentCell = parentCell.filter(function (d) {return d.depth > 0;});
         
//		parentCell.append("svg:rect")
//				  .attr("width", function (d) {return d.dx - 1;})
//				  .attr("height", pad)
//				  .style("fill", "orange")
//				  .style("fill-opacity", 0.5);
				  
        parentCell.append("text")
				  .text(function (d) {return d.name;})
          		  //sort of a patch
				  .attr("x", 10)
				  .attr("y", 15)
//				  .attr("x", function(d) { return (d.dx-d.name.length) / 2.2; })
//				  .attr("y", textHeight(root))
				  .style("font-size",20)
				  .style("font-weight", "bold");
		
		//and another one
		function textHeight(d) {
			var ky = h / d.dy;
            y.domain([d.y, d.y + d.dy]);
			return (ky * d.dy)/pad;
		}

}
DrawTreeMap();

$(window).resize(function () {
//  window.dataIndex = 0;
//  $('svg').remove();
//  $('.d3-tip').remove()
//  $('body').append('<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" xlink:xlink="http://www.w3.org/1999/xlink" class="tributary_svg0" width="100%" height="1600"></svg>');
//  window.scrollTo(0, 0);
//  DrawTreeMap();
});

$(window).scroll(function() {
   if($(window).scrollTop() + $(window).height() > $(document).height() - 50) {
     window.dataIndex = window.dataIndex + 1;
     $('body').append('<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" xlink:xlink="http://www.w3.org/1999/xlink" class="tributary_svg'+window.dataIndex.toString()+'" width="100%" height="1600"></svg>');
     DrawTreeMap();
       var new_div = '<div class="new_block"></div>';
       $('.main_content').append(new_div.load('/path/to/script.php'));
   }
});

</script>

</body>
</html>

